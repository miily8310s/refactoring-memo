# 第３章 コードの不吉な臭い

- 本章ではいつリファクタリングするか迷ったときの指針となる臭いの種類、その対処法となるリファクタリングを解説

## 不可思議な名前

- 明快なコードにするために最も重要なのは、適切な名前付け
  - 関数、モジュール、変数、クラスなどの名前
- 悲しいことに、名前付けは、プログラミングで最も難しいこと二つのうちの一つ
- 名前の変更がリファクタリングで最も行われる作業

### 対処するリファクタリング

- 「**関数宣言の変更**」
- 「**変数名の変更**」
- 「**フィールド名の変更**」

## 重複したコード

- 同じ構造のコードが２箇所以上にある場合、一つにまとめることができると、より良いプログラムになる
- 重複したコードの修正時には、重複部分をもれなく見つけ、すべてに同様の修正を施す必要がある

### 対処するリファクタリング

- 「**関数の抽出**」
  - 抽出したメソッドを元のメソッド本体から呼ぶようにする
- 「**ステートメントのスライド**」
  - 似てはいるが完全に同じではない場合がある
  - コードを整え、似た箇所を寄せておくと抽出しやすくなる
- 「**メソッドの引き上げ**」
  - 共通の親クラス配下のサブクラス間に重複したコードがある場合

## 長い関数

- 長く充実した人生を送るのは、短い関数を持ったプログラム
- 最もお勧めの方法は、関数名をわかりやすくすること
  - 関数名が適切であれば、内部の実装を見なくとも先に読みすすめていける
  - コメントが必要だと感じたとき、代わりにわかりやすい名前がついた関数に分割してしまうべき
  - そのコードが「意図」を示した名前をつけるようにする

### 対処するリファクタリング

- 「**関数の抽出**」
  - 関数を短くするための作業の 99％を占める
  - 巨大`switch`文に対しても有効
- 「**問い合わせによる一時変数の置き換え**」
  - 一時変数を減らす
- 「**パラメータオブジェクトの導入**」
- 「**オブジェクトそのものの受け渡し**」
  - 長いパラメータリストをスリムに
- 「**コマンドによる関数の置き換え**」
  - 上記 4 つの方法を試しても一時変数やパラメータが残っている場合に
- 「**条件記述の分解**」
  - 条件分岐やループの抽出に
- 「**ポリモーフィズムによる条件記述の置き換え**」
  - 同じ条件で分岐している`switch`文が複数あった場合
- 「**ループの分離**」
  - ループは、ループ部分とループ内部のコードを抽出して、独立した関数にできる

## 長いパラメータリスト

### 対処するリファクタリング

- 「**問い合わせによるパラメータの置き換え**」
  - パラメータで渡されるオブジェクトに問い合わせることで、パラメータリスト中の他のデータを取得できる場合がある
  - その場合は、その分のパラメータを削除できる
- 「**オブジェクトそのもの受け渡し**」
  - 元々のデータ構造を渡してしまう
- 「**パラメータオブジェクトの導入**」
  - 複数のパラメータが常に一緒に渡される場合に
- 「**フラグパラメータの削除**」
  - パラメータが振る舞いを変えるためのフラグとして使われている場合に
- 「**関数群のクラスへの集約**」
  - クラスはパラメータの数を減らすためのすぐれた手段
  - 複数の関数群が、パラメータで渡される値を共有しているときに特に有効
  - この共通の値をフィールドとして定義する

## グローバルなデータ

- グローバルなデータは、今でも遭遇する可能性のある、強烈な臭気の一つ
- コードベースのどこからでも変更できてしまい、どこで変更が行われたかを知るすべもない

### 対処するリファクタリング

- 「**変数のカプセル化**」
  - プログラムのあらゆる箇所の汚染にさらされたデータを見つけたときに
  - 少なくとも関数経由でのアクセスにすることで、いつ値を変更しているのかが突き止めやすくなり、制御できるようになる
