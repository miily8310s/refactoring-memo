# 第６章 リファクタリングはじめの一歩

## 最初に身に付けるべきリファクタリング

### 最も広く使われるリファクタリング

- 「**関数の抽出**」
- 「**変数の抽出**」
- 「**関数のインライン化**」
- 「**変数のインライン化**」

### 関数の命名

- 「**関数宣言の変更**」：関数の名前を変える
- 「**変数名の変更**」
- 「**変数のカプセル化**」
- 「**パラメータオブジェクトの導入**」
  - 引数の集まりを一つのオブジェクトにまとめる

### 関数をまとめる

- 「**関数群のクラスへの集約**」：関数群とそれらが操作するデータをまとめてクラスにする
- 「**関数群の変換への集約**」：関数を組み合わせて変数にする
- 「**フェーズの分離**」：モジュール群から固有の処理を行うフェーズ群を作る

## 関数の抽出

⇔ 「**関数のインライン化**」

### 動機

- 何をしているか調べなければわからないコードの断片があるとしたら、「何」をしているか示す名前の関数として抽出すべき
  - そうすると、関数名を読み返すだけで関数の目的がすぐに伝わる
  - 関数が６行を超えてくると、嫌な臭いがし始める

### 手順

1. 新たな関数を作り、その意図に沿って命名する（何をするかによって名付ける）
2. 抽出したいコードを、元の関数から新たな関数にコピーする
3. 抽出したコードを調べて、元の関数ではスコープ内だったが、抽出後の関数ではスコープ外担った変数を特定する。
   それらをパラメータとして渡す
4. すべての変数を処理したらコンパイルする
5. 元の関数に残った抽出前のコードを、抽出された関数への呼び出しに置き換える
6. テストする
7. 残りのコードを見て、抽出したコードと同じまたは類似したコードを探し、新しい関数を呼ぶ形に出来ないか検討する
   「関数呼び出しによるインラインコードの置き換え」を適用する。

### コード例

TODO: リンク貼る

## 関数のインライン化

⇔ 「**関数の抽出**」

### 動機

- うまく分割できていない関数群があるときにも使われる
- 一度、それらを一つの大きな関数にインライン化してから、より望ましい形の関数群として再抽出すればよい

### 手順

1. 関数がポリモーフィック（多態性）なメソッドでないことを確認する。
2. この関数の呼び出し元をすべて見つける
3. 関数の書く呼び出し元を関数の中身で置き換える
4. 一つ置き換えるごとにテストする
5. 関数の定義を取り除く

### コード例

TODO: リンク貼る

## 変数のインライン化

⇔ 「**変数の抽出**」

### 動機

- 変数は関数内の式に名前をもたらす
- しかし、ときに変数名が式以上のことを語らない場合がある
- そうしたときは、変数をインライン化する

### 手順

1. 代入の右辺に副作用がないことを確認する
2. そのヘンスが変更不可と宣言されていなければ、変更不可にしてテストする
3. その変数への最初の参照を探し、代入の右辺と置き換える
4. テストする
5. 変数を参照している箇所の置き換えを繰り返し、すべての参照箇所を更新する
6. 変数の宣言と代入を取り除く
7. テストする

### コード例

TODO: リンク貼る

## 関数宣言の変更

別名： 「**関数名の変更**」
別名： 「**シグニチャの変更**」

### 動機

- 関数はプログラムをいくつかの部品に分けるための第一の方法
- 関数宣言はそれらの部品がいかにうまく組み合わせられるかを表す
- 関数宣言はソフトウェア・システムにおける継ぎ目
- 良い継ぎ目があれば、システムに新たな部品を追加するのは簡単
- 悪い継ぎ目は常に問題の発生現になる
  - ソフトウェアが何をしているのかわかりにくくする
- 継ぎ目の要素で最も重要なのは関数名
  - その実装を見なくても関数が何をするのかが
- もし間違った名前の関数を見たら、少しでも良い名前がわかり次第、変更していかなければいけない
- パラメータにも同じ理屈が当てはまる

### 手順

#### 簡易な手順

1. パラメータを削除する場合、それが関数内部で参照されていないことを確認する
2. 関数宣言を望ましいものに変更する
3. 古い関数宣言へのすべての参照を探し、新しいものに更新する
4. テストする

#### 移行的手順

1. 必要なら関数の本体をリファクタリングして、以降の抽出のステップを実施しやすくする
2. 関数本体に「関数の抽出」を施して、新たな関数を作る
3. 抽出した関数が追加のパラメータを必要とする場合、簡易な手順により追加を行う
4. テストする
5. 古い関数に「関数のインライン化」を施す
6. 一時的な名前を使った場合、「関数宣言の変更」を再び施し、元の名前に戻る
7. テストする

### コード例

TODO: リンク貼る

## 変数のカプセル化

### 動機

- データは移動してもコードを動かし続けるために、すべての参照を一気に変更する必要がある
- 広い範囲で利用されるデータを移動したいときは、まずそれをカプセル化して、変数へのアクセスを関数経由にするのが非常に良いやり方
- データの変更や参照も監視できる

### 手順

1. 変数を参照・更新するためのカプセル化用関数を作る
2. 静的チェックを実行する
3. 変数への参照を、一つひとつ適切なカプセル化関数の呼び出しに置き換える。置き換えるごとにテストする
4. 変数の可視性を宣言する
5. テストする
6. 変更の値がレコードの場合、「レコードのカプセル化」を検討する

### コード例

TODO: リンク貼る
